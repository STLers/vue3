{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["// 判断是否为对象\r\nexport function isObject(value) {\r\n    return value !== null && typeof value === 'object'\r\n}","let activeEffect = void 0\r\nlet effectStack = []\r\n\r\nexport function isTracking() {\r\n    return activeEffect !== null && activeEffect !== undefined\r\n}\r\n\r\nfunction cleanupEffect(effect) {\r\n    const deps = effect.deps\r\n    for (const dep of deps) {\r\n        dep.delete(effect)\r\n    }\r\n\r\n}\r\nexport class ReactiveEffect {\r\n    active = true\r\n    deps = []\r\n    constructor(public fn) { }\r\n\r\n    run() {\r\n        if (!this.active) {\r\n            return this.fn()\r\n        }\r\n        try {\r\n            activeEffect = this\r\n            effectStack.push(this)\r\n            return this.fn()\r\n        } finally {\r\n            effectStack.pop()\r\n            activeEffect = effectStack[effectStack.length - 1]\r\n        }\r\n    }\r\n    // 接触effect和响应式对象的绑定\r\n    stop() {\r\n        if (this.active) {\r\n            cleanupEffect(this)\r\n            this.active = false\r\n        }\r\n    }\r\n}\r\n\r\n// 收集依赖\r\nexport const targetMap = new WeakMap()\r\nexport function track(target, key) {\r\n    if (!activeEffect) {\r\n        return\r\n    }\r\n    let depsMap = targetMap.get(target)\r\n    if (!depsMap) {\r\n        depsMap = new Map()\r\n        targetMap.set(target, depsMap)\r\n    }\r\n    let dep = depsMap.get(key)\r\n    if (!dep) {\r\n        depsMap.set(key, dep = new Set())\r\n    }\r\n    if (!dep.has(activeEffect)) {\r\n        dep.add(activeEffect)\r\n        activeEffect.deps.push(dep)\r\n    }\r\n}\r\n\r\n// 触发依赖\r\nexport function trigger(target, key) {\r\n    const depsMap = targetMap.get(target)\r\n    if (depsMap && key) {\r\n        const dep = depsMap.get(key)\r\n        const effects = [...dep]\r\n        for (const effect of effects) {\r\n            if (activeEffect !== effect) {\r\n                effect.run()\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nexport function effect(fn) {\r\n    const _effect = new ReactiveEffect(fn)\r\n    _effect.run()\r\n    const runner = _effect.run.bind(_effect)\r\n    runner.effect = _effect\r\n    return runner\r\n}","import { isObject } from \"@vue/shared\"\r\nimport { track, trigger } from \"./effect\"\r\nimport { ReactiveFlags, reactiveMap, readonlyMap, shallowReadonlyMap, readonly, reactive } from \"./reactive\"\r\n\r\nconst get = createGetter()\r\nconst set = createSetter()\r\nconst readonlyGet = createGetter(false, true)\r\nconst shallowReadonlyGet = createGetter(true, true)\r\n\r\nexport const mutableHandlers = {\r\n    get,\r\n    set,\r\n}\r\n\r\nexport const readonlyHandlers = {\r\n    get: readonlyGet,\r\n    set(target, key) {\r\n        console.warn(\r\n            `Set operation on key \"${String(key)}\" failed: target is readonly.`,\r\n            target\r\n        );\r\n        return true\r\n    }\r\n}\r\n\r\nexport const shallowReadonlyHandlers = {\r\n    get: shallowReadonlyGet,\r\n    set(target, key) {\r\n        console.warn(\r\n            `Set operation on key \"${String(key)}\" failed: target is readonly.`,\r\n            target\r\n        );\r\n        return true\r\n    }\r\n}\r\nfunction createGetter(shallow = false, isReadonly = false) {\r\n    return function get(target, key, receiver) {\r\n        const isExistInReactiveMap = () => key === ReactiveFlags.IS_RAW && reactiveMap.get(target)\r\n        const isExistInReadonlyMap = () => key === ReactiveFlags.IS_RAW && readonlyMap.get(target)\r\n        const isExistInShallowReadonlyMap = () => key === ReactiveFlags.IS_RAW && shallowReadonlyMap.get(target)\r\n\r\n        if (key === ReactiveFlags.IS_REACTIVE) {\r\n            return !shallow\r\n        } else if (key === ReactiveFlags.IS_READONLY) {\r\n            return isReadonly\r\n        } else if (isExistInReactiveMap() || isExistInReadonlyMap() || isExistInShallowReadonlyMap()) {\r\n            return target\r\n        }\r\n\r\n        const ret = Reflect.get(target, key, receiver)\r\n        if (!isReadonly) {\r\n            track(target, key)\r\n        }\r\n        if (shallow) {\r\n            return ret\r\n        }\r\n        if (isObject(ret)) {\r\n            return isReadonly ? readonly(ret) : reactive(ret)\r\n        }\r\n        return ret\r\n    }\r\n}\r\n\r\nfunction createSetter() {\r\n    return function set(target, key, value, receiver) {\r\n        const oldValue = target[key]\r\n        const ret = Reflect.set(target, key, value, receiver)\r\n\r\n        if (oldValue !== value) {\r\n            trigger(target, key)\r\n        }\r\n        return ret\r\n    }\r\n}","import { isObject } from \"@vue/shared\"\r\nimport { mutableHandlers, readonlyHandlers, shallowReadonlyHandlers } from \"./baseHandlers\"\r\n\r\nexport const enum ReactiveFlags {\r\n    IS_REACTIVE = '__v_isReactive',\r\n    IS_READONLY = '__v_isReadonly',\r\n    IS_RAW = '__v_isRAW'\r\n}\r\n// 存储已经reactive包装的对象\r\nexport const reactiveMap = new WeakMap()\r\n// 存储已经readonly包装的对象\r\nexport const readonlyMap = new WeakMap()\r\n// 存储已经shallowReadonly包装的对象\r\nexport const shallowReadonlyMap = new WeakMap()\r\n\r\nexport function reactive(target) {\r\n    return createReactiveObject(target, reactiveMap, mutableHandlers)\r\n}\r\n\r\nexport function readonly(target) {\r\n    return createReactiveObject(target, readonlyMap, readonlyHandlers)\r\n}\r\n\r\nexport function shallowReadonly(target) {\r\n    return createReactiveObject(target, shallowReadonlyMap, shallowReadonlyHandlers)\r\n}\r\n\r\nfunction createReactiveObject(target, proxyMap, baseHandlers) {\r\n    // 只处理对象\r\n    if (!isObject(target)) {\r\n        return target\r\n    }\r\n    // 避免重复包装已经处理的对象\r\n    if (target['__v_isRAW']) {\r\n        return target\r\n    }\r\n    // 判断是否已经存在对应类型的target\r\n    const exitingProxy = proxyMap.get(target)\r\n    if (exitingProxy) {\r\n        return exitingProxy\r\n    }\r\n\r\n    const proxy = new Proxy(target, baseHandlers)\r\n    // 存储target，防止重复代理\r\n    proxyMap.set(target, proxy)\r\n    return proxy\r\n}"],"names":[],"mappings":"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"}